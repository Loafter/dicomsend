package filereciversrv
import (
	"net/http"
	"strconv"
	"io/ioutil"
	"log"
	"encoding/base64"
	"crypto/rand"
	"fmt"
	"os"
	"dicomsend/http_receiver"
	"godownloader/monitor"
	"encoding/json"
)

const htmlData = "PCFkb2N0eXBlIGh0bWw+DQoNCjxodG1sPg0KDQo8aGVhZD4NCiAgICA8dGl0bGU+RElDT00gRFJPUEJPWDwvdGl0bGU+DQogICAgPG1ldGEgbmFtZT0idmlld3BvcnQiIGNvbnRlbnQ9IndpZHRoPWRldmljZS13aWR0aCI+DQogICAgPGxpbmsgcmVsPSJzdHlsZXNoZWV0IiBocmVmPSJodHRwczovL25ldGRuYS5ib290c3RyYXBjZG4uY29tL2Jvb3Rzd2F0Y2gvMy4wLjAvam91cm5hbC9ib290c3RyYXAubWluLmNzcyI+DQogICAgPGxpbmsgcmVsPSJzdHlsZXNoZWV0IiB0eXBlPSJ0ZXh0L2NzcyIgbWVkaWE9InNjcmVlbiIgaHJlZj0iaHR0cDovL3d3dy5ndXJpZGRvLm5ldC9kZW1vL2Nzcy90cmlyYW5kL3VpLmpxZ3JpZC1ib290c3RyYXAuY3NzIj4NCiAgICA8c2NyaXB0IHR5cGU9InRleHQvamF2YXNjcmlwdCIgc3JjPSJodHRwczovL2FqYXguZ29vZ2xlYXBpcy5jb20vYWpheC9saWJzL2pxdWVyeS8yLjAuMy9qcXVlcnkubWluLmpzIj48L3NjcmlwdD4NCiAgICA8c2NyaXB0IHR5cGU9InRleHQvamF2YXNjcmlwdCIgc3JjPSJodHRwczovL25ldGRuYS5ib290c3RyYXBjZG4uY29tL2Jvb3RzdHJhcC8zLjMuNC9qcy9ib290c3RyYXAubWluLmpzIj48L3NjcmlwdD4NCiAgICA8c2NyaXB0IHR5cGU9InRleHQvamF2YXNjcmlwdCIgc3JjPSJodHRwOi8vd3d3Lmd1cmlkZG8ubmV0L2RlbW8vanMvdHJpcmFuZC9qcXVlcnkuanFHcmlkLm1pbi5qcyI+PC9zY3JpcHQ+DQogICAgPHNjcmlwdCB0eXBlPSJ0ZXh0L2phdmFzY3JpcHQiIHNyYz0iaHR0cDovL3d3dy5ndXJpZGRvLm5ldC9kZW1vL2pzL3RyaXJhbmQvaTE4bi9ncmlkLmxvY2FsZS1lbi5qcyI+PC9zY3JpcHQ+DQogICAgPGxpbmsgcmVsPSJzdHlsZXNoZWV0IiBocmVmPSIvL2NvZGUuanF1ZXJ5LmNvbS91aS8xLjExLjQvdGhlbWVzL3Ntb290aG5lc3MvanF1ZXJ5LXVpLmNzcyI+DQogICAgPHNjcmlwdCBzcmM9Imh0dHA6Ly9jb2RlLmpxdWVyeS5jb20vdWkvMS4xMS40L2pxdWVyeS11aS5qcyI+PC9zY3JpcHQ+DQogICAgPHN0eWxlIGNsYXNzPSJjcC1wZW4tc3R5bGVzIj4NCiAgICAgICAgI2Ryb3B6b25lIHsNCiAgICAgICAgICAgIHBvc2l0aW9uOiByZWxhdGl2ZTsNCiAgICAgICAgICAgIGJvcmRlcjogMTBweCBkb3R0ZWQgZ3JleTsNCiAgICAgICAgICAgIGJvcmRlci1yYWRpdXM6IDIwcHg7DQogICAgICAgICAgICBjb2xvcjogZ3JleTsNCiAgICAgICAgICAgIGZvbnQ6IGJvbGQgMjRweC8yMDBweCBhcmlhbDsNCiAgICAgICAgICAgIGhlaWdodDogMjUwcHg7DQogICAgICAgICAgICBtYXJnaW46IDMwcHggYXV0bzsNCiAgICAgICAgICAgIHRleHQtYWxpZ246IGNlbnRlcjsNCiAgICAgICAgICAgIHdpZHRoOiA4MDBweDsNCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgI2Ryb3B6b25lLmhvdmVyIHsNCiAgICAgICAgICAgIGJvcmRlcjogMTBweCBzb2xpZCAjRkU1Ow0KICAgICAgICAgICAgY29sb3I6ICNGRTU7DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgICNkcm9wem9uZS5kcm9wcGVkIHsNCiAgICAgICAgICAgIGJhY2tncm91bmQ6ICMyMjI7DQogICAgICAgICAgICBib3JkZXI6IDEwcHggc29saWQgIzQ0NDsNCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgI2Ryb3B6b25lIGRpdiB7DQogICAgICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7DQogICAgICAgICAgICB0b3A6IDA7DQogICAgICAgICAgICByaWdodDogMDsNCiAgICAgICAgICAgIGJvdHRvbTogMDsNCiAgICAgICAgICAgIGxlZnQ6IDA7DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgICNkcm9wem9uZSBbdHlwZT0iZmlsZSJdIHsNCiAgICAgICAgICAgIGN1cnNvcjogcG9pbnRlcjsNCiAgICAgICAgICAgIHBvc2l0aW9uOiBhYnNvbHV0ZTsNCiAgICAgICAgICAgIG9wYWNpdHk6IDA7DQogICAgICAgICAgICB0b3A6IDA7DQogICAgICAgICAgICByaWdodDogMDsNCiAgICAgICAgICAgIGJvdHRvbTogMDsNCiAgICAgICAgICAgIGxlZnQ6IDA7DQogICAgICAgIH0NCiAgICA8L3N0eWxlPg0KICAgIDxzdHlsZSB0eXBlPSJ0ZXh0L2NzcyI+DQogICAgICAgIGJvZHkgew0KICAgICAgICAgICAgcGFkZGluZy10b3A6IDUwcHg7DQogICAgICAgICAgICBwYWRkaW5nLWJvdHRvbTogMjBweDsNCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgLnRhYmxlIC5wcm9ncmVzcyB7DQogICAgICAgICAgICBtYXJnaW4tYm90dG9tOiAwcHg7DQogICAgICAgIH0NCiAgICA8L3N0eWxlPg0KICAgIDxzY3JpcHQgc3JjPScvL2Fzc2V0cy5jb2RlcGVuLmlvL2Fzc2V0cy9jb21tb24vc3RvcEV4ZWN1dGlvbk9uVGltZW91dC5qcz90PTEnPjwvc2NyaXB0Pg0KDQogICAgPHNjcmlwdD4NCiAgICAgICAgJChmdW5jdGlvbigpIHsNCiAgICAgICAgICAgICQoJyNkcm9wem9uZScpLm9uKCdkcmFnb3ZlcicsIGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgICAgICQodGhpcykuYWRkQ2xhc3MoJ2hvdmVyJyk7DQogICAgICAgICAgICB9KTsNCiAgICAgICAgICAgICQoJyNkcm9wem9uZScpLm9uKCdkcmFnbGVhdmUnLCBmdW5jdGlvbigpIHsNCiAgICAgICAgICAgICAgICAkKHRoaXMpLnJlbW92ZUNsYXNzKCdob3ZlcicpOw0KICAgICAgICAgICAgfSk7DQoNCg0KICAgICAgICAgICAgJCgiZm9ybSNmb3JtX2RhdGFfaWQiKS5zdWJtaXQoZnVuY3Rpb24oZXZlbnQpIHsNCiAgICAgICAgICAgICAgICAvL2Rpc2FibGUgdGhlIGRlZmF1bHQgZm9ybSBzdWJtaXNzaW9uDQogICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsNCiAgICAgICAgICAgICAgICAvL2dyYWIgYWxsIGZvcm0gZGF0YQ0KICAgICAgICAgICAgICAgIHZhciBmb3JtRGF0YSA9IG5ldyBGb3JtRGF0YSgkKHRoaXMpWzBdKTsNCg0KICAgICAgICAgICAgICAgICQuYWpheCh7DQogICAgICAgICAgICAgICAgICAgIHVybDogJ2h0dHA6Ly8nICsgbG9jYXRpb24uaG9zdCArICcvdXBsb2FkX2RpY29tJywNCiAgICAgICAgICAgICAgICAgICAgdHlwZTogJ1BPU1QnLA0KICAgICAgICAgICAgICAgICAgICBkYXRhOiBmb3JtRGF0YSwNCiAgICAgICAgICAgICAgICAgICAgYXN5bmM6IHRydWUsDQogICAgICAgICAgICAgICAgICAgIGNhY2hlOiBmYWxzZSwNCiAgICAgICAgICAgICAgICAgICAgY29udGVudFR5cGU6IGZhbHNlLA0KICAgICAgICAgICAgICAgICAgICBwcm9jZXNzRGF0YTogZmFsc2UNCiAgICAgICAgICAgICAgICB9KTsNCg0KICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsNCiAgICAgICAgICAgIH0pOw0KDQoNCiAgICAgICAgICAgICQoJyNkcm9wem9uZSBpbnB1dCcpLm9uKCdjaGFuZ2UnLCBmdW5jdGlvbihlKSB7DQogICAgICAgICAgICAgICAgJCgnI2ZfcG9ydF9pZCcpLnZhbCgkKCcjcG9ydF9pZCcpLnZhbCgpKQ0KICAgICAgICAgICAgICAgICQoJyNmX2FldF9pZCcpLnZhbCgkKCcjYWV0X2lkJykudmFsKCkpDQogICAgICAgICAgICAgICAgJCgnI2Zfc2VydmVyX2lkJykudmFsKCQoJyNzZXJ2ZXJfaWQnKS52YWwoKSkNCiAgICAgICAgICAgICAgICAkKCcjZm9ybV9kYXRhX2lkJykuc3VibWl0KCkNCiAgICAgICAgICAgIH0pOw0KICAgICAgICB9KTsNCiAgICA8L3NjcmlwdD4NCiAgICA8c2NyaXB0Pg0KICAgICAgICBmdW5jdGlvbiBVcGRhdGVUYWJsZSgpIHsNCiAgICAgICAgICAgICQoIiNqcUdyaWQiKS5qcUdyaWQoew0KICAgICAgICAgICAgICAgIHVybDogJ2h0dHA6Ly8nICsgbG9jYXRpb24uaG9zdG5hbWUgKyAnOjk5ODIvcHJvZ3Jlc3NfdXBsb2FkLmpzb24nLA0KICAgICAgICAgICAgICAgIG10eXBlOiAiR0VUIiwNCiAgICAgICAgICAgICAgICBhamF4U3ViZ3JpZE9wdGlvbnM6IHsNCiAgICAgICAgICAgICAgICAgICAgYXN5bmM6IGZhbHNlDQogICAgICAgICAgICAgICAgfSwNCiAgICAgICAgICAgICAgICBzdHlsZVVJOiAnQm9vdHN0cmFwJywNCiAgICAgICAgICAgICAgICBkYXRhdHlwZTogImpzb24iLA0KICAgICAgICAgICAgICAgIGNvbE1vZGVsOiBbew0KICAgICAgICAgICAgICAgICAgICBsYWJlbDogJyUnLA0KICAgICAgICAgICAgICAgICAgICBuYW1lOiAnUHJvZ3Jlc3MnLA0KICAgICAgICAgICAgICAgICAgICB3aWR0aDogMTANCiAgICAgICAgICAgICAgICB9LCB7DQogICAgICAgICAgICAgICAgICAgIGxhYmVsOiAnUHJvZ3Jlc3MnLA0KICAgICAgICAgICAgICAgICAgICBuYW1lOiAnUHJvZ3Jlc3MnLA0KICAgICAgICAgICAgICAgICAgICBmb3JtYXR0ZXI6IEZvcm1hdFByb2dyZXNzQmFyDQogICAgICAgICAgICAgICAgfSwgew0KICAgICAgICAgICAgICAgICAgICBsYWJlbDogJ1VJRCcsDQogICAgICAgICAgICAgICAgICAgIG5hbWU6ICdVaWQnDQogICAgICAgICAgICAgICAgfSwgew0KICAgICAgICAgICAgICAgICAgICBsYWJlbDogJ1NUT1AnLA0KICAgICAgICAgICAgICAgICAgICBuYW1lOiAnVWlkJywNCiAgICAgICAgICAgICAgICAgICAgZm9ybWF0dGVyOiBGb3JtYXREZWxsQnV0dG9uLA0KICAgICAgICAgICAgICAgICAgICB3aWR0aDogMTksDQogICAgICAgICAgICAgICAgfV0sDQogICAgICAgICAgICAgICAgdmlld3JlY29yZHM6IHRydWUsDQogICAgICAgICAgICAgICAgcm93TnVtOiA1LA0KICAgICAgICAgICAgICAgIHBhZ2VyOiAiI2pxR3JpZFBhZ2VyIg0KICAgICAgICAgICAgfSk7DQogICAgICAgIH0NCg0KICAgICAgICBmdW5jdGlvbiBGaXhUYWJsZSgpIHsNCiAgICAgICAgICAgICQuZXh0ZW5kKCQuamdyaWQuYWpheE9wdGlvbnMsIHsNCiAgICAgICAgICAgICAgICBhc3luYzogZmFsc2UNCiAgICAgICAgICAgIH0pDQogICAgICAgICAgICAkKCIjanFHcmlkIikNCiAgICAgICAgICAgICAgICAuc2V0R3JpZFdpZHRoKCQod2luZG93KQ0KICAgICAgICAgICAgICAgICAgICAud2lkdGgoKSAtIDUpDQogICAgICAgICAgICAkKCIjanFHcmlkIikNCiAgICAgICAgICAgICAgICAuc2V0R3JpZEhlaWdodCgkKHdpbmRvdykNCiAgICAgICAgICAgICAgICAgICAgLmhlaWdodCgpKQ0KICAgICAgICAgICAgJCh3aW5kb3cpDQogICAgICAgICAgICAgICAgLmJpbmQoJ3Jlc2l6ZScsIGZ1bmN0aW9uKCkgew0KICAgICAgICAgICAgICAgICAgICAkKCIjanFHcmlkIikNCiAgICAgICAgICAgICAgICAgICAgICAgIC5zZXRHcmlkV2lkdGgoJCh3aW5kb3cpDQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLndpZHRoKCkgLSA1KTsNCiAgICAgICAgICAgICAgICAgICAgJCgiI2pxR3JpZCIpDQogICAgICAgICAgICAgICAgICAgICAgICAuc2V0R3JpZEhlaWdodCgkKHdpbmRvdykNCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuaGVpZ2h0KCkpDQogICAgICAgICAgICAgICAgfSkNCiAgICAgICAgfQ0KDQoNCiAgICAgICAgZnVuY3Rpb24gZGVsZXRlVXAoZSkgew0KICAgICAgICAgICAgJC5hamF4KHsNCiAgICAgICAgICAgICAgICB1cmw6ICJkZWxldGVfdXBsb2FkIiwNCiAgICAgICAgICAgICAgICB0eXBlOiAiUE9TVCIsDQogICAgICAgICAgICAgICAgZGF0YTogSlNPTi5zdHJpbmdpZnkoZS5pZCksDQogICAgICAgICAgICAgICAgZGF0YVR5cGU6ICJqc29uIiwNCiAgICAgICAgICAgIH0pDQogICAgICAgIH0NCg0KICAgICAgICBmdW5jdGlvbiBVcGRhdGVEYXRhKCkgew0KICAgICAgICAgICAgdmFyIGdyaWQgPSAkKCIjanFHcmlkIik7DQogICAgICAgICAgICB2YXIgcm93S2V5ID0gZ3JpZC5qcUdyaWQoJ2dldEdyaWRQYXJhbScsICJzZWxyb3ciKTsNCiAgICAgICAgICAgICQoIiNqcUdyaWQiKS50cmlnZ2VyKCJyZWxvYWRHcmlkIik7DQogICAgICAgICAgICBpZiAocm93S2V5KSB7DQogICAgICAgICAgICAgICAgJCgnI2pxR3JpZCcpLmpxR3JpZCgicmVzZXRTZWxlY3Rpb24iKQ0KICAgICAgICAgICAgICAgICQoJyNqcUdyaWQnKS5qcUdyaWQoJ3NldFNlbGVjdGlvbicsIHJvd0tleSk7DQogICAgICAgICAgICB9DQogICAgICAgIH0NCg0KICAgICAgICBmdW5jdGlvbiBGb3JtYXRQcm9ncmVzc0JhcihjZWxsVmFsdWUsIG9wdGlvbnMsIHJvd09iamVjdCkgew0KICAgICAgICAgICAgdmFyIGludFZhbCA9IHBhcnNlSW50KGNlbGxWYWx1ZSk7DQogICAgICAgICAgICB2YXIgY2VsbEh0bWwgPSAnPGRpdiBjbGFzcz0icHJvZ3Jlc3MiPjxkaXYgY2xhc3M9InByb2dyZXNzLWJhciIgc3R5bGU9IndpZHRoOiAnICsgaW50VmFsICsgJyU7Ij48L2Rpdj48L2Rpdj4nDQogICAgICAgICAgICByZXR1cm4gY2VsbEh0bWw7DQogICAgICAgIH0NCg0KICAgICAgICBmdW5jdGlvbiBGb3JtYXREZWxsQnV0dG9uKGNlbGxWYWx1ZSwgb3B0aW9ucywgcm93T2JqZWN0KSB7DQogICAgICAgICAgICB2YXIgaW50VmFsID0gcGFyc2VJbnQoY2VsbFZhbHVlKTsNCiAgICAgICAgICAgIHZhciBjZWxsSHRtbCA9ICc8ZGl2IGNsYXNzPSJjb250cm9scyI+PGEgIG9uY2xpY2s9ImRlbGV0ZVVwKHRoaXMpIiBpZD0iJyArIGNlbGxWYWx1ZSArICciIGNsYXNzPSJidG4gcHVsbC1sZWZ0IGJ0bi1zdWNjZXNzIGJ0bi14cyI+U1RPUDwvYT48L2Rpdj4nDQogICAgICAgICAgICByZXR1cm4gY2VsbEh0bWw7DQogICAgICAgIH0NCg0KICAgICAgICBmdW5jdGlvbiBPbkxvYWQoKSB7DQogICAgICAgICAgICBVcGRhdGVUYWJsZSgpDQogICAgICAgICAgICBGaXhUYWJsZSgpDQogICAgICAgICAgICBzZXRJbnRlcnZhbChVcGRhdGVEYXRhLCA1MDApOw0KICAgICAgICB9DQogICAgPC9zY3JpcHQ+DQo8L2hlYWQ+DQoNCjxib2R5IG9ubG9hZD0iT25Mb2FkKCkiPg0KICAgIDxkaXYgY2xhc3M9Im5hdmJhciBuYXZiYXItaW52ZXJzZSBuYXZiYXItZml4ZWQtdG9wIj4NCiAgICAgICAgPGRpdiBjbGFzcz0iY29udGFpbmVyIj4NCiAgICAgICAgICAgIDxkaXYgY2xhc3M9Im5hdmJhci1oZWFkZXIiPg0KICAgICAgICAgICAgICAgIDxidXR0b24gdHlwZT0iYnV0dG9uIiBjbGFzcz0ibmF2YmFyLXRvZ2dsZSIgZGF0YS10b2dnbGU9ImNvbGxhcHNlIiBkYXRhLXRhcmdldD0iLm5hdmJhci1jb2xsYXBzZSI+DQogICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJpY29uLWJhciI+PC9zcGFuPjxzcGFuIGNsYXNzPSJpY29uLWJhciI+PC9zcGFuPjxzcGFuIGNsYXNzPSJpY29uLWJhciI+PC9zcGFuPg0KICAgICAgICAgICAgICAgIDwvYnV0dG9uPg0KICAgICAgICAgICAgICAgIDxhIGNsYXNzPSJuYXZiYXItYnJhbmQiIGhyZWY9IiMiPmRpY29tIGRyb3Bib3g8L2E+DQogICAgICAgICAgICA8L2Rpdj4NCiAgICAgICAgICAgIDxkaXYgY2xhc3M9Im5hdmJhci1jb2xsYXBzZSBjb2xsYXBzZSI+DQogICAgICAgICAgICAgICAgPHVsIGNsYXNzPSJuYXYgbmF2YmFyLW5hdiI+DQogICAgICAgICAgICAgICAgICAgIDxsaSBjbGFzcz0iZHJvcGRvd24iPg0KICAgICAgICAgICAgICAgICAgICAgICAgPGEgaHJlZj0iIyIgY2xhc3M9ImRyb3Bkb3duLXRvZ2dsZSIgZGF0YS10b2dnbGU9ImRyb3Bkb3duIj5TZXRpbmdzIDxiIGNsYXNzPSJjYXJldCI+PC9iPjwvYT4NCiAgICAgICAgICAgICAgICAgICAgICAgIDx1bCBjbGFzcz0iZHJvcGRvd24tbWVudSI+DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGxpPg0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8YSBkYXRhLXRvZ2dsZT0ibW9kYWwiIGRhdGEtdGFyZ2V0PSIjbXlNb2RhbCI+Tm9kZSBzZXR0aW5nczwvYT4NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2xpPg0KDQogICAgICAgICAgICAgICAgICAgICAgICA8L3VsPg0KICAgICAgICAgICAgICAgICAgICA8L2xpPg0KDQogICAgICAgICAgICAgICAgICAgIDxsaT4NCiAgICAgICAgICAgICAgICAgICAgICAgIDxhIGhyZWY9IiNhYm91dCI+QWJvdXQ8L2E+DQogICAgICAgICAgICAgICAgICAgIDwvbGk+DQogICAgICAgICAgICAgICAgPC91bD4NCiAgICAgICAgICAgIDwvZGl2Pg0KICAgICAgICAgICAgPCEtLS8ubmF2YmFyLWNvbGxhcHNlIC0tPg0KICAgICAgICA8L2Rpdj4NCiAgICA8L2Rpdj4NCiAgICA8L1A+DQoNCiAgICA8Zm9ybSBhY3Rpb249Imh0dHA6Ly8nK2xvY2F0aW9uLmhvc3QrJy91cGxvYWRfZGljb20iIG1ldGhvZD0icG9zdCIgZW5jdHlwZT0ibXVsdGlwYXJ0L2Zvcm0tZGF0YSIgaWQ9ImZvcm1fZGF0YV9pZCI+DQogICAgICAgIDwhLS08aW5wdXQgdHlwZT0iZmlsZSIgbmFtZT0iZmlsZXMiIGlkPSJmaWxlcyIgbXVsdGlwbGU+LS0+DQogICAgICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuYW1lPSJzZXJ2ZXIiIHZhbHVlPSIxOTIuMTY4LjEyMy4yMzEiIGlkPSJmX3NlcnZlcl9pZCIgaGlkZGVuLz4NCiAgICAgICAgPGlucHV0IHR5cGU9InRleHQiIG5hbWU9InBvcnQiIHZhbHVlPSIxMDQiIGlkPSJmX3BvcnRfaWQiIGhpZGRlbi8+DQogICAgICAgIDxpbnB1dCB0eXBlPSJ0ZXh0IiBuYW1lPSJhZXRpdGxlIiB2YWx1ZT0iQUVfQVJDSDEiIGlkPSJmX2FldF9pZCIgaGlkZGVuLz4NCg0KICAgICAgICA8ZGl2IGlkPSJkcm9wem9uZSI+DQogICAgICAgICAgICA8ZGl2PkRyb3AgZm9sZGVyIHdpdGggRElDT00gc3R1ZGllcyBoZXJlPC9kaXY+DQogICAgICAgICAgICA8aW5wdXQgdHlwZT0iZmlsZSIgbmFtZT0iZmlsZXMiIG11bHRpcGxlIGRpcmVjdG9yeSB3ZWJraXRkaXJlY3RvcnkgbW96ZGlyZWN0b3J5Lz4NCiAgICAgICAgPC9kaXY+DQogICAgPC9mb3JtPg0KICAgIDwhLS0gTW9kYWwgLS0+DQogICAgPGRpdiBjbGFzcz0ibW9kYWwgZmFkZSIgaWQ9Im15TW9kYWwiIHJvbGU9ImRpYWxvZyI+DQogICAgICAgIDxkaXYgY2xhc3M9Im1vZGFsLWRpYWxvZyI+DQoNCiAgICAgICAgICAgIDwhLS0gTW9kYWwgY29udGVudC0tPg0KICAgICAgICAgICAgPGRpdiBjbGFzcz0ibW9kYWwtY29udGVudCI+DQogICAgICAgICAgICAgICAgPGRpdiBjbGFzcz0ibW9kYWwtaGVhZGVyIj4NCiAgICAgICAgICAgICAgICAgICAgPGJ1dHRvbiB0eXBlPSJidXR0b24iIGNsYXNzPSJjbG9zZSIgZGF0YS1kaXNtaXNzPSJtb2RhbCI+JnRpbWVzOzwvYnV0dG9uPg0KICAgICAgICAgICAgICAgICAgICA8aDQgY2xhc3M9Im1vZGFsLXRpdGxlIj5TZXJ2ZXIgc2V0dGluZ3M8L2g0Pg0KICAgICAgICAgICAgICAgIDwvZGl2Pg0KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9Im1vZGFsLWJvZHkiPg0KICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJmb3JtLWdyb3VwIj4NCiAgICAgICAgICAgICAgICAgICAgICAgIDxsYWJlbCBjbGFzcz0iY29udHJvbC1sYWJlbCI+U2VydmVyIGlwIG9yIG5hbWU8L2xhYmVsPg0KDQogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJjb250cm9scyI+DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGlucHV0IHR5cGU9InRleHQiIGlkPSJzZXJ2ZXJfaWQiIGNsYXNzPSJmb3JtLWNvbnRyb2wiIHZhbHVlPSIxOTIuMTY4LjEyMy4yMzEiPg0KICAgICAgICAgICAgICAgICAgICAgICAgPC9kaXY+DQogICAgICAgICAgICAgICAgICAgICAgICA8bGFiZWwgY2xhc3M9ImNvbnRyb2wtbGFiZWwiPlBvcnQ8L2xhYmVsPg0KDQogICAgICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPSJjb250cm9scyI+DQogICAgICAgICAgICAgICAgICAgICAgICAgICAgPGlucHV0IHR5cGU9InRleHQiIGlkPSJwb3J0X2lkIiBjbGFzcz0iZm9ybS1jb250cm9sIiB2YWx1ZT0iMTA0Ij4NCiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2Pg0KICAgICAgICAgICAgICAgICAgICAgICAgPGxhYmVsIGNsYXNzPSJjb250cm9sLWxhYmVsIj5BRSB0aXRsZTwvbGFiZWw+DQoNCiAgICAgICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImNvbnRyb2xzIj4NCiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8aW5wdXQgdHlwZT0idGV4dCIgaWQ9ImFldF9pZCIgY2xhc3M9ImZvcm0tY29udHJvbCIgdmFsdWU9IkFFX0FSQ0gxIj4NCiAgICAgICAgICAgICAgICAgICAgICAgIDwvZGl2Pg0KICAgICAgICAgICAgICAgICAgICA8L2Rpdj4NCiAgICAgICAgICAgICAgICA8L2Rpdj4NCiAgICAgICAgICAgIDwvZGl2Pg0KDQogICAgICAgIDwvZGl2Pg0KICAgIDwvZGl2Pg0KICAgIDx0YWJsZSBpZD0ianFHcmlkIj48L3RhYmxlPg0KPC9ib2R5Pg0KDQo8L2h0bWw+"
const FlushDiskSize = 1024 * 1024


func genUid() string {
	b := make([]byte, 16)
	rand.Read(b)
	return fmt.Sprintf("%X-%X-%X-%X-%X", b[0:4], b[4:6], b[6:8], b[8:10], b[10:])
}
type Upst struct {
	Uid      string
	Progress int64
}

func sep() string {
	st := strconv.QuoteRune(os.PathSeparator)
	st = st[1 : len(st) - 1]
	return st
}
type UpSrv struct {
	drs map[string]*monitor.MonitoredWorker
}

func (srv *UpSrv) Start(listenPort int) error {
	srv.drs = make(map[string]*monitor.MonitoredWorker)
	http.HandleFunc("/", srv.Redirect)
	http.HandleFunc("/index.html", srv.index)
	http.HandleFunc("/upload_dicom", srv.uploadDicom)
	http.HandleFunc("/progress_upload.json", srv.progressJson)
	http.HandleFunc("/delete_upload", srv.deleteUpload)
	if err := http.ListenAndServe(":" + strconv.Itoa(listenPort), nil); err != nil {
		return err
	}
	return nil
}
func (srv *UpSrv) Redirect(responseWriter http.ResponseWriter, request *http.Request) {
	http.Redirect(responseWriter, request, "/index.html", 301)
}


func (srv *UpSrv) index(rwr http.ResponseWriter, req *http.Request) {
	rwr.Header().Set("Content-Type: text/html", "*")
	content, err := ioutil.ReadFile("index.html")
	if err != nil {
		log.Println("warning: start page not found, return included page")
		val, _ := base64.StdEncoding.DecodeString(htmlData)
		rwr.Write(val)
		return
	}
	rwr.Write(content)
}



func (srv *UpSrv)uploadDicom(w http.ResponseWriter, r *http.Request) {
	defer r.Body.Close()
	if fr, err := httpreciver.CreateReciver(w, r); err != nil {
		http.Error(w, "error: can't create reciver", http.StatusInternalServerError)

	}else {
		mw := monitor.MonitoredWorker{Itw:fr}
		srv.drs[mw.GetId()] = &mw
		mw.Start()
		mw.Wait()
		log.Println(mw.GetState())
	}
	log.Println("info: finish upload")
	w.Write([]byte{0})
}


func (srv *UpSrv) progressJson(rwr http.ResponseWriter, req *http.Request) {
	defer req.Body.Close()
	rwr.Header().Set("Access-Control-Allow-Origin", "*")
	jbs := make([]Upst, 0, len(srv.drs))
	for ind, i := range srv.drs {
		if i.GetState() == monitor.Running {


			prs, _ := i.GetProgress().(int64)
			st := Upst{Uid:ind, Progress:prs}
			jbs = append(jbs, st)
		}else {
			delete(srv.drs, ind)
		}

	}
	js, err := json.Marshal(jbs)
	if err != nil {
		http.Error(rwr, err.Error(), http.StatusInternalServerError)
		return
	}
	rwr.Write(js)

}
func (srv *UpSrv) deleteUpload(rwr http.ResponseWriter, req *http.Request) {
	defer req.Body.Close()
	rwr.Header().Set("Access-Control-Allow-Origin", "*")
	bodyData, err := ioutil.ReadAll(req.Body)
	if err != nil {
		http.Error(rwr, err.Error(), http.StatusInternalServerError)
		log.Println(err)
		return
	}
	var uid string
	if err := json.Unmarshal(bodyData, &uid); err != nil {
		http.Error(rwr, err.Error(), http.StatusInternalServerError)
		log.Println(err)
		return
	}
	if val, ok := srv.drs[uid]; ok {
		val.Stop()
		delete(srv.drs, uid)
		log.Println("info: remove upload jobs with id",uid)
	}else {
		log.Println("warning: can't find upload with id ", uid)
}
	rwr.Write([]byte{0})

}
